

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>compiler.pycodegen &mdash; Python Standard Library</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/py.png"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Python Standard Library" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Python Standard Library
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../01to10.html">Ch 01 - 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11to20.html">Ch 11 - 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../21to30.html">Ch 21 - 30</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../31to37.html">Ch 31 - 37</a></li>
</ul>
<p class="caption"><span class="caption-text">Autogenerated API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_06to10.html">API: 06 - 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_11to15.html">API: 11 - 15</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_16to20.html">API: 16 - 20</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_21to25.html">API: 21 - 25</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_26to30.html">API: 26 - 30</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_31to37.html">API: 31 - 37</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python Standard Library</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>compiler.pycodegen</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for compiler.pycodegen</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">marshal</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">compiler</span> <span class="kn">import</span> <span class="n">ast</span><span class="p">,</span> <span class="n">parse</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="n">syntax</span>
<span class="kn">from</span> <span class="nn">compiler</span> <span class="kn">import</span> <span class="n">pyassem</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">future</span><span class="p">,</span> <span class="n">symbols</span>
<span class="kn">from</span> <span class="nn">compiler.consts</span> <span class="kn">import</span> <span class="n">SC_LOCAL</span><span class="p">,</span> <span class="n">SC_GLOBAL_IMPLICIT</span><span class="p">,</span> <span class="n">SC_GLOBAL_EXPLICIT</span><span class="p">,</span> \
     <span class="n">SC_FREE</span><span class="p">,</span> <span class="n">SC_CELL</span>
<span class="kn">from</span> <span class="nn">compiler.consts</span> <span class="kn">import</span> <span class="p">(</span><span class="n">CO_VARARGS</span><span class="p">,</span> <span class="n">CO_VARKEYWORDS</span><span class="p">,</span> <span class="n">CO_NEWLOCALS</span><span class="p">,</span>
     <span class="n">CO_NESTED</span><span class="p">,</span> <span class="n">CO_GENERATOR</span><span class="p">,</span> <span class="n">CO_FUTURE_DIVISION</span><span class="p">,</span>
     <span class="n">CO_FUTURE_ABSIMPORT</span><span class="p">,</span> <span class="n">CO_FUTURE_WITH_STATEMENT</span><span class="p">,</span> <span class="n">CO_FUTURE_PRINT_FUNCTION</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">compiler.pyassem</span> <span class="kn">import</span> <span class="n">TupleArg</span>

<span class="c1"># XXX The version-specific code can go, since this code only works with 2.x.</span>
<span class="c1"># Do we have Python 1.x or Python 2.x?</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">callfunc_opcode_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># (Have *args, Have **args) : opcode</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;CALL_FUNCTION&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;CALL_FUNCTION_VAR&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;CALL_FUNCTION_KW&quot;</span><span class="p">,</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="s2">&quot;CALL_FUNCTION_VAR_KW&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">LOOP</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">EXCEPT</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">TRY_FINALLY</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">END_FINALLY</span> <span class="o">=</span> <span class="mi">4</span>

<div class="viewcode-block" id="compileFile"><a class="viewcode-back" href="../../generated/compiler.compileFile.html#compiler.compileFile">[docs]</a><span class="k">def</span> <span class="nf">compileFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">display</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="compile"><a class="viewcode-back" href="../../generated/compiler.compile.html#compiler.compile">[docs]</a><span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dont_inherit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replacement for builtin compile() function&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">dont_inherit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s2">&quot;not implemented yet&quot;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">Interactive</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;exec&quot;</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">Module</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;eval&quot;</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;compile() 3rd arg must be &#39;exec&#39; or &quot;</span>
                         <span class="s2">&quot;&#39;eval&#39; or &#39;single&#39;&quot;</span><span class="p">)</span>
    <span class="n">gen</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">gen</span><span class="o">.</span><span class="n">code</span></div>

<span class="k">class</span> <span class="nc">AbstractCompileMode</span><span class="p">:</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># defined by subclass</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_get_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">misc</span><span class="o">.</span><span class="n">set_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
        <span class="n">syntax</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c1"># implemented by subclass</span>

    <span class="k">def</span> <span class="nf">getCode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span>

<span class="k">class</span> <span class="nc">Expression</span><span class="p">(</span><span class="n">AbstractCompileMode</span><span class="p">):</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;eval&quot;</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tree</span><span class="p">()</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">ExpressionCodeGenerator</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">getCode</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Interactive</span><span class="p">(</span><span class="n">AbstractCompileMode</span><span class="p">):</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tree</span><span class="p">()</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">InteractiveCodeGenerator</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">getCode</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Module</span><span class="p">(</span><span class="n">AbstractCompileMode</span><span class="p">):</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;exec&quot;</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tree</span><span class="p">()</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">ModuleCodeGenerator</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pprint</span>
            <span class="k">print</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">getCode</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getPycHeader</span><span class="p">())</span>
        <span class="n">marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">MAGIC</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">get_magic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getPycHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># compile.c uses marshal to write a long directly, with</span>
        <span class="c1"># calling the interface that would also generate a 1-byte code</span>
        <span class="c1"># to indicate the type of the value.  simplest way to get the</span>
        <span class="c1"># same effect is to call marshal and then skip the code.</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAGIC</span> <span class="o">+</span> <span class="n">mtime</span>

<span class="k">class</span> <span class="nc">LocalNameFinder</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find local names in scope&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">Set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># XXX list comprehensions and for loops</span>

    <span class="k">def</span> <span class="nf">getLocals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">elements</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">has_elt</span><span class="p">(</span><span class="n">elt</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span>

    <span class="k">def</span> <span class="nf">visitDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visitGlobal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitLambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visitImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitAssName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_constant_false</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Const</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">CodeGenerator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Defines basic code generator for Python bytecode</span>

<span class="sd">    This class is an abstract base class.  Concrete subclasses must</span>
<span class="sd">    define an __init__() that defines self.graph and then calls the</span>
<span class="sd">    __init__() defined in this class.</span>

<span class="sd">    The concrete class must also define the class attributes</span>
<span class="sd">    NameFinder, FunctionGen, and ClassGen.  These attributes can be</span>
<span class="sd">    defined in the initClass() method, which is a hook for</span>
<span class="sd">    initializing these methods after all the classes have been</span>
<span class="sd">    defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">optimized</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># is namespace access optimized?</span>
    <span class="n">__initialized</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">class_name</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># provide default for instance variable</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initialized</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initClass</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__initialized</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkClass</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">Stack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">Stack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_lineno</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setupGraphDelegation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_div_op</span> <span class="o">=</span> <span class="s2">&quot;BINARY_DIVIDE&quot;</span>

        <span class="c1"># XXX set flags based on future features</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_module</span><span class="p">()</span><span class="o">.</span><span class="n">futures</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;division&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_FUTURE_DIVISION</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_div_op</span> <span class="o">=</span> <span class="s2">&quot;BINARY_TRUE_DIVIDE&quot;</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;absolute_import&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_FUTURE_ABSIMPORT</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;with_statement&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_FUTURE_WITH_STATEMENT</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">feature</span> <span class="o">==</span> <span class="s2">&quot;print_function&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_FUTURE_PRINT_FUNCTION</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is called once for each class&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">checkClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Verify that class is constructed correctly&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;NameFinder&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;FunctionGen&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ClassGen&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">intro</span> <span class="o">=</span> <span class="s2">&quot;Bad class construction for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="n">intro</span>

    <span class="k">def</span> <span class="nf">_setupGraphDelegation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">emit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">newBlock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">startBlock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nextBlock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDocstring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setDocstring</span>

    <span class="k">def</span> <span class="nf">getCode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a code object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">getCode</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">mangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">misc</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">parseSymbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">SymbolVisitor</span><span class="p">()</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">scopes</span>

    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s2">&quot;should be implemented by subclasses&quot;</span>

    <span class="c1"># Next five methods handle name access</span>

    <span class="k">def</span> <span class="nf">isLocalName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">has_elt</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">storeName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nameOp</span><span class="p">(</span><span class="s1">&#39;STORE&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loadName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nameOp</span><span class="p">(</span><span class="s1">&#39;LOAD&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nameOp</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_nameOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">check_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="n">SC_LOCAL</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_NAME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_FAST&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="o">==</span> <span class="n">SC_GLOBAL_EXPLICIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_GLOBAL&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="o">==</span> <span class="n">SC_GLOBAL_IMPLICIT</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_NAME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_GLOBAL&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="o">==</span> <span class="n">SC_FREE</span> <span class="ow">or</span> <span class="n">scope</span> <span class="o">==</span> <span class="n">SC_CELL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_DEREF&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="s2">&quot;unsupported scope for var </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_implicitNameOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emit name ops for names generated implicitly by for loops</span>

<span class="sd">        The interpreter generates names that start with a period or</span>
<span class="sd">        dollar sign.  The symbol table ignores these names because</span>
<span class="sd">        they aren&#39;t present in the program text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_FAST&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_NAME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># The set_lineno() function and the explicit emit() calls for</span>
    <span class="c1"># SET_LINENO below are only used to generate the line number table.</span>
    <span class="c1"># As of Python 2.3, the interpreter does not have a SET_LINENO</span>
    <span class="c1"># instruction.  pyassem treats SET_LINENO opcodes as a special case.</span>

    <span class="k">def</span> <span class="nf">set_lineno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emit SET_LINENO if necessary.</span>

<span class="sd">        The instruction is considered necessary if the node has a</span>
<span class="sd">        lineno attribute and it is different than the last lineno</span>
<span class="sd">        emitted.</span>

<span class="sd">        Returns true if SET_LINENO was emitted.</span>

<span class="sd">        There are no rules for when an AST node should have a lineno</span>
<span class="sd">        attribute.  The transformer and AST code need to be reviewed</span>
<span class="sd">        and a consistent policy implemented and documented.  Until</span>
<span class="sd">        then, this method works around missing line numbers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lineno</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_lineno</span>
                                   <span class="ow">or</span> <span class="n">force</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SET_LINENO&#39;</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_lineno</span> <span class="o">=</span> <span class="n">lineno</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># The first few visitor methods handle nodes that generator new</span>
    <span class="c1"># code objects.  They use class attributes to determine what</span>
    <span class="c1"># specialized code generators to use.</span>

    <span class="n">NameFinder</span> <span class="o">=</span> <span class="n">LocalNameFinder</span>
    <span class="n">FunctionGen</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ClassGen</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">visitModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseSymbols</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SET_LINENO&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">)</span>
        <span class="n">lnf</span> <span class="o">=</span> <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameFinder</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">lnf</span><span class="o">.</span><span class="n">getLocals</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RETURN_VALUE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseSymbols</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RETURN_VALUE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visitFuncOrLambda</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">isLambda</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDocstring</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitLambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visitFuncOrLambda</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">isLambda</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_visitFuncOrLambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">isLambda</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isLambda</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">decorators</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorators</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">decorator</span><span class="p">)</span>
            <span class="n">ndecorators</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">decorators</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ndecorators</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FunctionGen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">,</span> <span class="n">isLambda</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_module</span><span class="p">())</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeClosure</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndecorators</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;CALL_FUNCTION&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ClassGen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_module</span><span class="p">())</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_TUPLE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">bases</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeClosure</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;CALL_FUNCTION&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_CLASS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># The rest are standard visitor methods</span>

    <span class="c1"># The next few implement control-flow statements</span>

    <span class="k">def</span> <span class="nf">visitIf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">numtests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tests</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numtests</span><span class="p">):</span>
            <span class="n">test</span><span class="p">,</span> <span class="n">suite</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_constant_false</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
                <span class="c1"># XXX will need to check generator stuff here</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="n">nextTest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="n">nextTest</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_FORWARD&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">nextTest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitWhile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">else_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>

        <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SETUP_LOOP&#39;</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">loop</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="n">else_</span> <span class="ow">or</span> <span class="n">after</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">else_</span><span class="p">)</span> <span class="c1"># or just the POPs if not else clause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_BLOCK&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SETUP_LOOP&#39;</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;GET_ITER&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;FOR_ITER&#39;</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">assign</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_BLOCK&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitBreak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;&#39;break&#39; outside loop (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BREAK_LOOP&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitContinue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;&#39;continue&#39; outside loop (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="n">kind</span><span class="p">,</span> <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">LOOP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">EXCEPT</span> <span class="ow">or</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">TRY_FINALLY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="c1"># find the block that starts the loop</span>
            <span class="n">top</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">top</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">kind</span><span class="p">,</span> <span class="n">loop_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">[</span><span class="n">top</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">LOOP</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">!=</span> <span class="n">LOOP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;&#39;continue&#39; outside loop (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> \
                      <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;CONTINUE_LOOP&#39;</span><span class="p">,</span> <span class="n">loop_block</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">END_FINALLY</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&#39;continue&#39; not allowed inside &#39;finally&#39; clause (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitTest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">jump</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">jump</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitAnd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitTest</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;JUMP_IF_FALSE_OR_POP&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitOr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitTest</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;JUMP_IF_TRUE_OR_POP&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitIfExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">endblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">elseblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="n">elseblock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">then</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_FORWARD&#39;</span><span class="p">,</span> <span class="n">endblock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">elseblock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">endblock</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitCompare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">cleanup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_THREE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;COMPARE_OP&#39;</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_IF_FALSE_OR_POP&#39;</span><span class="p">,</span> <span class="n">cleanup</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="c1"># now do the last comparison</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="n">op</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;COMPARE_OP&#39;</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_FORWARD&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_TWO&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="c1"># list comprehensions</span>
    <span class="k">def</span> <span class="nf">visitListComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># setup list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_LIST&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">for_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)),</span> <span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">for_</span><span class="p">)</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">if_</span> <span class="ow">in</span> <span class="n">for_</span><span class="o">.</span><span class="n">ifs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">if_</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LIST_APPEND&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitSetComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># setup list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_SET&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">for_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)),</span> <span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">for_</span><span class="p">)</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">if_</span> <span class="ow">in</span> <span class="n">for_</span><span class="o">.</span><span class="n">ifs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">if_</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SET_ADD&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitDictComp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># setup list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_MAP&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">for_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)),</span> <span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">for_</span><span class="p">)</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">if_</span> <span class="ow">in</span> <span class="n">for_</span><span class="o">.</span><span class="n">ifs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">if_</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;MAP_ADD&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitListCompFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;GET_ITER&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;FOR_ITER&#39;</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">assign</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">anchor</span>

    <span class="k">def</span> <span class="nf">visitListCompIf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_makeClosure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">frees</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_free_vars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CLOSURE&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_TUPLE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frees</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;MAKE_CLOSURE&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;MAKE_FUNCTION&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitGenExpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="n">GenExprCodeGenerator</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">get_module</span><span class="p">())</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_makeClosure</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># precomputation of outmost iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;GET_ITER&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;CALL_FUNCTION&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitGenExprInner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># setup list</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">for_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">)),</span> <span class="n">node</span><span class="o">.</span><span class="n">quals</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">for_</span><span class="p">)</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">if_</span> <span class="ow">in</span> <span class="n">for_</span><span class="o">.</span><span class="n">ifs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cont</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cont</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">if_</span><span class="p">,</span> <span class="n">cont</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;YIELD_VALUE&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">cont</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cont</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_BLOCK&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitGenExprFor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SETUP_LOOP&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_outmost</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadName</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;GET_ITER&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;FOR_ITER&#39;</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">assign</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">anchor</span><span class="p">,</span> <span class="n">end</span>

    <span class="k">def</span> <span class="nf">visitGenExprIf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">branch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>

    <span class="c1"># exception related</span>

    <span class="k">def</span> <span class="nf">visitAssert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># XXX would be interesting to implement this via a</span>
        <span class="c1"># transformation of the AST before this stage</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="c1"># XXX AssertionError appears to be special case -- it is always</span>
            <span class="c1"># loaded as a global even if there is a local name.  I guess this</span>
            <span class="c1"># is a sort of renaming op.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_TRUE&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_GLOBAL&#39;</span><span class="p">,</span> <span class="s1">&#39;AssertionError&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">fail</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RAISE_VARARGS&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RAISE_VARARGS&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitRaise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">expr1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr1</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">expr2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr2</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">expr3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr3</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RAISE_VARARGS&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitTryExcept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="n">lElse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lElse</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SETUP_EXCEPT&#39;</span><span class="p">,</span> <span class="n">handlers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">EXCEPT</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_BLOCK&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_FORWARD&#39;</span><span class="p">,</span> <span class="n">lElse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startBlock</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>

        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">handlers</span><span class="p">)):</span>
            <span class="n">expr</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;COMPARE_OP&#39;</span><span class="p">,</span> <span class="s1">&#39;exception match&#39;</span><span class="p">)</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="nb">next</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;JUMP_FORWARD&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;END_FINALLY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">lElse</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitTryFinally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SETUP_FINALLY&#39;</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">TRY_FINALLY</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_BLOCK&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">END_FINALLY</span><span class="p">,</span> <span class="n">final</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">final</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;END_FINALLY&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">__with_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">visitWith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="n">final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__with_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">valuevar</span> <span class="o">=</span> <span class="s2">&quot;_[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__with_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_ATTR&#39;</span><span class="p">,</span> <span class="s1">&#39;__exit__&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_TWO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_ATTR&#39;</span><span class="p">,</span> <span class="s1">&#39;__enter__&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;CALL_FUNCTION&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">vars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_implicitNameOp</span><span class="p">(</span><span class="s1">&#39;STORE&#39;</span><span class="p">,</span> <span class="n">valuevar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SETUP_FINALLY&#39;</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">TRY_FINALLY</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_implicitNameOp</span><span class="p">(</span><span class="s1">&#39;LOAD&#39;</span><span class="p">,</span> <span class="n">valuevar</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_implicitNameOp</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">valuevar</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_BLOCK&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextBlock</span><span class="p">(</span><span class="n">final</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">push</span><span class="p">((</span><span class="n">END_FINALLY</span><span class="p">,</span> <span class="n">final</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;WITH_CLEANUP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;END_FINALLY&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__with_count</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># misc</span>

    <span class="k">def</span> <span class="nf">visitDiscard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitConst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitKeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitGlobal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># no code to generate</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visitName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitPass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">checkFlag</span><span class="p">(</span><span class="n">CO_FUTURE_ABSIMPORT</span><span class="p">)</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;IMPORT_NAME&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resolveDots</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">level</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">checkFlag</span><span class="p">(</span><span class="n">CO_FUTURE_ABSIMPORT</span><span class="p">):</span>
            <span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">fromlist</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="n">fromlist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;IMPORT_NAME&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">modname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;IMPORT_STAR&#39;</span><span class="p">)</span>
                    <span class="c1"># There can only be one name w/ from ... import *</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;IMPORT_FROM&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_resolveDots</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">alias</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;IMPORT_FROM&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolveDots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">elts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">elts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_ATTR&#39;</span><span class="p">,</span> <span class="n">elt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitGetattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_ATTR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrname</span><span class="p">))</span>

    <span class="c1"># next five implement assignments</span>

    <span class="k">def</span> <span class="nf">visitAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">dups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">elt</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dups</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitAssName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_ASSIGN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_DELETE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;oops&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span>

    <span class="k">def</span> <span class="nf">visitAssAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_ASSIGN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_ATTR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrname</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_DELETE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DELETE_ATTR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;warning: unexpected flags:&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span>
            <span class="k">print</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">_visitAssSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;UNPACK_SEQUENCE&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">findOp</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;OP_DELETE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">visitAssTuple</span> <span class="o">=</span> <span class="n">_visitAssSequence</span>
        <span class="n">visitAssList</span> <span class="o">=</span> <span class="n">_visitAssSequence</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">visitAssTuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visitAssSequence</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNPACK_TUPLE&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">visitAssList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visitAssSequence</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNPACK_LIST&#39;</span><span class="p">)</span>

    <span class="c1"># augmented assignment</span>

    <span class="k">def</span> <span class="nf">visitAugAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">aug_node</span> <span class="o">=</span> <span class="n">wrap_aug</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">aug_node</span><span class="p">,</span> <span class="s2">&quot;load&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_augmented_opcode</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">aug_node</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">)</span>

    <span class="n">_augmented_opcode</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;+=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_ADD&#39;</span><span class="p">,</span>
        <span class="s1">&#39;-=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_SUBTRACT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;*=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_MULTIPLY&#39;</span><span class="p">,</span>
        <span class="s1">&#39;/=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_DIVIDE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;//=&#39;</span><span class="p">:</span> <span class="s1">&#39;INPLACE_FLOOR_DIVIDE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_MODULO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;**=&#39;</span><span class="p">:</span> <span class="s1">&#39;INPLACE_POWER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&gt;&gt;=&#39;</span><span class="p">:</span> <span class="s1">&#39;INPLACE_RSHIFT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;&lt;=&#39;</span><span class="p">:</span> <span class="s1">&#39;INPLACE_LSHIFT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&amp;=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_AND&#39;</span><span class="p">,</span>
        <span class="s1">&#39;^=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_XOR&#39;</span><span class="p">,</span>
        <span class="s1">&#39;|=&#39;</span> <span class="p">:</span> <span class="s1">&#39;INPLACE_OR&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">visitAugName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitAugGetattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_ATTR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrname</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_TWO&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_ATTR&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mangle</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrname</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visitAugSlice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visitSlice</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span><span class="p">:</span>
            <span class="nb">slice</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
                <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span> <span class="o">|</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">upper</span><span class="p">:</span>
                <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span> <span class="o">|</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="nb">slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_TWO&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">slice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_FOUR&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_THREE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_SLICE+</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">slice</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitAugSubscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visitSubscript</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;store&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_THREE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_SUBSCR&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitExec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">locals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">locals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">globals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;EXEC_STMT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitCallFunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Keyword</span><span class="p">):</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">star_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">star_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dstar_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dstar_args</span><span class="p">)</span>
        <span class="n">have_star</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">star_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">have_dstar</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">dstar_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">opcode</span> <span class="o">=</span> <span class="n">callfunc_opcode_info</span><span class="p">[</span><span class="n">have_star</span><span class="p">,</span> <span class="n">have_dstar</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">opcode</span><span class="p">,</span> <span class="n">kw</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitPrint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dest</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_TWO&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;PRINT_ITEM_TO&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;PRINT_ITEM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dest</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">newline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;POP_TOP&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitPrintnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visitPrint</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;PRINT_NEWLINE_TO&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;PRINT_NEWLINE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitReturn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RETURN_VALUE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitYield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;YIELD_VALUE&#39;</span><span class="p">)</span>

    <span class="c1"># slice and subscript stuff</span>

    <span class="k">def</span> <span class="nf">visitSlice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">aug_flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># aug_flag is used by visitAugSlice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="nb">slice</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
            <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span> <span class="o">|</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">upper</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>
            <span class="nb">slice</span> <span class="o">=</span> <span class="nb">slice</span> <span class="o">|</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">aug_flag</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">slice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">slice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOPX&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOPX&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_APPLY&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;SLICE+</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">slice</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_ASSIGN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_SLICE+</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">slice</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_DELETE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DELETE_SLICE+</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">slice</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s2">&quot;weird slice&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">visitSubscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">aug_flag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">subs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">subs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_TUPLE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">subs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">aug_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOPX&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_APPLY&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BINARY_SUBSCR&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_ASSIGN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_SUBSCR&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s1">&#39;OP_DELETE&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DELETE_SUBSCR&#39;</span><span class="p">)</span>

    <span class="c1"># binary ops</span>

    <span class="k">def</span> <span class="nf">binaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_ADD&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitSub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_SUBTRACT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitMul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_MULTIPLY&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitDiv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_div_op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitFloorDiv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_FLOOR_DIVIDE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitMod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_MODULO&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitPower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_POWER&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitLeftShift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_LSHIFT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitRightShift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;BINARY_RSHIFT&#39;</span><span class="p">)</span>

    <span class="c1"># unary ops</span>

    <span class="k">def</span> <span class="nf">unaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitInvert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNARY_INVERT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitUnarySub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNARY_NEGATIVE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitUnaryAdd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNARY_POSITIVE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitUnaryInvert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNARY_INVERT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitNot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNARY_NOT&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitBackquote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unaryOp</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;UNARY_CONVERT&#39;</span><span class="p">)</span>

    <span class="c1"># bit ops</span>

    <span class="k">def</span> <span class="nf">bitOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitBitand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitOp</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;BINARY_AND&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitBitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitOp</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;BINARY_OR&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitBitxor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bitOp</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="s1">&#39;BINARY_XOR&#39;</span><span class="p">)</span>

    <span class="c1"># object constructors</span>

    <span class="k">def</span> <span class="nf">visitEllipsis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">Ellipsis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visitTuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_TUPLE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visitList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_LIST&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visitSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_SET&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visitSliceobj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_SLICE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visitDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;BUILD_MAP&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;DUP_TOP&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;ROT_THREE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;STORE_SUBSCR&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NestedScopeMixin</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Defines initClass() for nested scoping (Python 2.2-compatible)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">initClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">NameFinder</span> <span class="o">=</span> <span class="n">LocalNameFinder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">FunctionGen</span> <span class="o">=</span> <span class="n">FunctionCodeGenerator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">ClassGen</span> <span class="o">=</span> <span class="n">ClassCodeGenerator</span>

<span class="k">class</span> <span class="nc">ModuleCodeGenerator</span><span class="p">(</span><span class="n">NestedScopeMixin</span><span class="p">,</span> <span class="n">CodeGenerator</span><span class="p">):</span>
    <span class="n">__super_init</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="o">.</span><span class="n">__init__</span>

    <span class="n">scopes</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">pyassem</span><span class="o">.</span><span class="n">PyFlowGraph</span><span class="p">(</span><span class="s2">&quot;&lt;module&gt;&quot;</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">find_futures</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__super_init</span><span class="p">()</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">ExpressionCodeGenerator</span><span class="p">(</span><span class="n">NestedScopeMixin</span><span class="p">,</span> <span class="n">CodeGenerator</span><span class="p">):</span>
    <span class="n">__super_init</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="o">.</span><span class="n">__init__</span>

    <span class="n">scopes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">pyassem</span><span class="o">.</span><span class="n">PyFlowGraph</span><span class="p">(</span><span class="s2">&quot;&lt;expression&gt;&quot;</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__super_init</span><span class="p">()</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">InteractiveCodeGenerator</span><span class="p">(</span><span class="n">NestedScopeMixin</span><span class="p">,</span> <span class="n">CodeGenerator</span><span class="p">):</span>

    <span class="n">__super_init</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="o">.</span><span class="n">__init__</span>

    <span class="n">scopes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">pyassem</span><span class="o">.</span><span class="n">PyFlowGraph</span><span class="p">(</span><span class="s2">&quot;&lt;interactive&gt;&quot;</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__super_init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RETURN_VALUE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">visitDiscard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># XXX Discard means it&#39;s an expression.  Perhaps this is a bad</span>
        <span class="c1"># name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;PRINT_EXPR&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AbstractFunctionCode</span><span class="p">:</span>
    <span class="n">optimized</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lambdaCount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">isLambda</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">class_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="k">if</span> <span class="n">isLambda</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="n">FunctionCodeGenerator</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&lt;lambda.</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">klass</span><span class="o">.</span><span class="n">lambdaCount</span>
            <span class="n">klass</span><span class="o">.</span><span class="n">lambdaCount</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">lambdaCount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">name</span>

        <span class="n">args</span><span class="p">,</span> <span class="n">hasTupleArg</span> <span class="o">=</span> <span class="n">generateArgList</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">argnames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">pyassem</span><span class="o">.</span><span class="n">PyFlowGraph</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                                         <span class="n">optimized</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isLambda</span> <span class="o">=</span> <span class="n">isLambda</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">super_init</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isLambda</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDocstring</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>

        <span class="n">lnf</span> <span class="o">=</span> <span class="n">walk</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameFinder</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">lnf</span><span class="o">.</span><span class="n">getLocals</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">varargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_VARARGS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_VARKEYWORDS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hasTupleArg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generateArgUnpack</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">argnames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">startExitBlock</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isLambda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_CONST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RETURN_VALUE&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generateArgUnpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_FAST&#39;</span><span class="p">,</span> <span class="s1">&#39;.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unpackSequence</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unpackSequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tup</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">VERSION</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;UNPACK_SEQUENCE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;UNPACK_TUPLE&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">tup</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unpackSequence</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nameOp</span><span class="p">(</span><span class="s1">&#39;STORE&#39;</span><span class="p">,</span> <span class="n">elt</span><span class="p">)</span>

    <span class="n">unpackTuple</span> <span class="o">=</span> <span class="n">unpackSequence</span>

<span class="k">class</span> <span class="nc">FunctionCodeGenerator</span><span class="p">(</span><span class="n">NestedScopeMixin</span><span class="p">,</span> <span class="n">AbstractFunctionCode</span><span class="p">,</span>
                            <span class="n">CodeGenerator</span><span class="p">):</span>
    <span class="n">super_init</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="o">.</span><span class="n">__init__</span> <span class="c1"># call be other init</span>
    <span class="n">scopes</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">__super_init</span> <span class="o">=</span> <span class="n">AbstractFunctionCode</span><span class="o">.</span><span class="n">__init__</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">isLambda</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__super_init</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">isLambda</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFreeVars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_free_vars</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setCellVars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_cell_vars</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_GENERATOR</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GenExprCodeGenerator</span><span class="p">(</span><span class="n">NestedScopeMixin</span><span class="p">,</span> <span class="n">AbstractFunctionCode</span><span class="p">,</span>
                           <span class="n">CodeGenerator</span><span class="p">):</span>
    <span class="n">super_init</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="o">.</span><span class="n">__init__</span> <span class="c1"># call be other init</span>
    <span class="n">scopes</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">__super_init</span> <span class="o">=</span> <span class="n">AbstractFunctionCode</span><span class="o">.</span><span class="n">__init__</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gexp</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">gexp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__super_init</span><span class="p">(</span><span class="n">gexp</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFreeVars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_free_vars</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setCellVars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_cell_vars</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_GENERATOR</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AbstractClassCode</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">pyassem</span><span class="o">.</span><span class="n">PyFlowGraph</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                                           <span class="n">optimized</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">super_init</span><span class="p">()</span>
        <span class="n">lnf</span> <span class="o">=</span> <span class="n">walk</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NameFinder</span><span class="p">(),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locals</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">lnf</span><span class="o">.</span><span class="n">getLocals</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFlag</span><span class="p">(</span><span class="n">CO_NEWLOCALS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDocstring</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">startExitBlock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;LOAD_LOCALS&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;RETURN_VALUE&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ClassCodeGenerator</span><span class="p">(</span><span class="n">NestedScopeMixin</span><span class="p">,</span> <span class="n">AbstractClassCode</span><span class="p">,</span> <span class="n">CodeGenerator</span><span class="p">):</span>
    <span class="n">super_init</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="o">.</span><span class="n">__init__</span>
    <span class="n">scopes</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">__super_init</span> <span class="o">=</span> <span class="n">AbstractClassCode</span><span class="o">.</span><span class="n">__init__</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">klass</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__super_init</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">scopes</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setFreeVars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_free_vars</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">setCellVars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_cell_vars</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lineno</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;LOAD_GLOBAL&quot;</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">doc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;LOAD_CONST&quot;</span><span class="p">,</span> <span class="n">klass</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storeName</span><span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generateArgList</span><span class="p">(</span><span class="n">arglist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate an arg list marking TupleArgs&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arglist</span><span class="p">)):</span>
        <span class="n">elt</span> <span class="o">=</span> <span class="n">arglist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TupleArg</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">elt</span><span class="p">))</span>
            <span class="n">extra</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">misc</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">elt</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;unexpect argument type:&quot;</span><span class="p">,</span> <span class="n">elt</span>
    <span class="k">return</span> <span class="n">args</span> <span class="o">+</span> <span class="n">extra</span><span class="p">,</span> <span class="n">count</span>

<span class="k">def</span> <span class="nf">findOp</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the op (DELETE, LOAD, STORE) in an AssTuple tree&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">OpFinder</span><span class="p">()</span>
    <span class="n">walk</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">op</span>

<span class="k">class</span> <span class="nc">OpFinder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">visitAssName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">!=</span> <span class="n">node</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s2">&quot;mixed ops in stmt&quot;</span>
    <span class="n">visitAssAttr</span> <span class="o">=</span> <span class="n">visitAssName</span>
    <span class="n">visitSubscript</span> <span class="o">=</span> <span class="n">visitAssName</span>

<span class="k">class</span> <span class="nc">Delegator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class to support delegation for augmented assignment nodes</span>

<span class="sd">    To generator code for augmented assignments, we use the following</span>
<span class="sd">    wrapper classes.  In visitAugAssign, the left-hand expression node</span>
<span class="sd">    is visited twice.  The first time the visit uses the normal method</span>
<span class="sd">    for that node .  The second time the visit uses a different method</span>
<span class="sd">    that generates the appropriate code to perform the assignment.</span>
<span class="sd">    These delegator classes wrap the original AST nodes in order to</span>
<span class="sd">    support the variant visit methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AugGetattr</span><span class="p">(</span><span class="n">Delegator</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">AugName</span><span class="p">(</span><span class="n">Delegator</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">AugSlice</span><span class="p">(</span><span class="n">Delegator</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">AugSubscript</span><span class="p">(</span><span class="n">Delegator</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">wrapper</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Getattr</span><span class="p">:</span> <span class="n">AugGetattr</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span> <span class="n">AugName</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Slice</span><span class="p">:</span> <span class="n">AugSlice</span><span class="p">,</span>
    <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">:</span> <span class="n">AugSubscript</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">wrap_aug</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">wrapper</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="p">](</span><span class="n">node</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">compileFile</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/copybutton.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>